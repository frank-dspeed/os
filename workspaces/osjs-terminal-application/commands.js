export const config = (ctx, core) => ({_}) => {
  _.forEach(key => {
    const value = JSON.stringify(core.config(key), null, 4);
    ctx.writeln(`${key}: ${value}`);
  });
};

export const windows = (ctx, core) => () => {
  core.make('osjs/windows')
    .list()
    .forEach(w => ctx.writeln(JSON.stringify(w.getSession())));
};

export const run = (ctx, core) => (args) => {
  if (args._.length) {
    return core.run(args._[0], args);
  }

  return Promise.reject(new Error('No application name given'));
};

export const open = (ctx, core) => (args) => {
  if (args._.length && args.mime) {
    return core.open({
      path: args._[0],
      mime: args.mime
    });
  }

  return Promise.reject(new Error('No filename or mime given'));
};

const wrapFS = (method) => (ctx, core) => (args) => {
  const arg = args._[0];
  if (arg) {
    return core.make('osjs/vfs')[method](arg)
      .then(result => ctx.writeln(`${method} ${arg}: ${result ? 'OK' : 'Fail'}`));
  }

  return Promise.reject(new Error('No filename given'));
};

export const rm = wrapFS('unlink');
export const mkdir = wrapFS('mkdir');
export const touch = wrapFS('touch');

export const cat = (ctx, core) => (args) => {
  const arg = args._[0];
  if (arg) {
    return core.make('osjs/vfs')
      .readfile(arg)
      .then(contents => ctx.write(contents));
  }

  return Promise.reject(new Error('No filename given'));
};

export const ls = (ctx, core) => (args) => {
  const path = args._[0] || 'osjs:/';

  ctx.writeln('Listing directory ' + path);

  return core.make('osjs/vfs')
    .readdir(path)
    .then(results => results.forEach(iter => {
      const filename = iter.filename.substring(0, 40).padEnd(40, ' ');
      const mime = (iter.mime || '').substring(0, 24).padEnd(24, ' ');
      const type = iter.isDirectory ? 'D' : 'F';
      const size = `${String(iter.size || 0)}B`.padEnd(12, ' ');

      ctx.writeln(`${filename} ${type} ${size} ${mime}`);
    }));
};

export const clear = (ctx) => () => Promise.resolve(ctx.clear());

export const exec = (ctx, core, xterm) => (args, input) => {
  const [name, ...argv] = input.split(' ');

  core.make('osjs/proc')
    .pty(name, ...argv)
    .then(p => {
      p.attachXterm(xterm);
      p.on('exit', () => ctx.close());
      p.on('error', err => ctx.close(err));
    })
    .catch(err => ctx.close(err));
};

export const help = (ctx) => () => {
  const str = `Available commands:

  help: This command
  clear: Clear screen
  banner: Display nammer
  ls <dir>: Lists a directory
  rm <dir>: Removes a file or directory
  cat <filename>: Prints or concatenates files
  mkdir <dir>: Creates a directory
  touch <filename>: Creates a file
  run <name> [--args]: Starts application
  open <filename> --mime MIME: Opens given file
  windows: Lists all windows
  config <key>: Prints a configuration option
  exec ...: Executes a PTY process on host
`;

  str.split('\n').forEach(l => ctx.writeln(l));

  return Promise.resolve();
};

export const banner = (ctx) => () => {
  const str = `
[48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;238m  [48;5;60m  [48;5;60m  [48;5;238m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [0m
[48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;238m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [0m
[48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;238m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [0m
[48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;238m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [0m
[48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;238m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [0m
[48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;238m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [0m
[48;5;0m  [48;5;0m  [48;5;238m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;0m  [48;5;0m  [0m
[48;5;238m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [0m
[48;5;237m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [0m
[48;5;238m  [48;5;60m  [48;5;238m  [48;5;239m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;239m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;60m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;60m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;60m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;238m  [48;5;60m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [0m
[48;5;238m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;236m  [0m
[48;5;236m  [48;5;237m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [48;5;236m  [48;5;235m  [0m
[48;5;0m  [48;5;0m  [48;5;236m  [48;5;237m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [48;5;236m  [48;5;235m  [48;5;0m  [48;5;0m  [0m
[48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;236m  [48;5;237m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [48;5;236m  [48;5;235m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [0m
[48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;236m  [48;5;237m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [48;5;236m  [48;5;235m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [0m
[48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;236m  [48;5;237m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;24m  [48;5;237m  [48;5;236m  [48;5;235m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [0m
[48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;236m  [48;5;237m  [48;5;60m  [48;5;61m  [48;5;61m  [48;5;60m  [48;5;237m  [48;5;24m  [48;5;24m  [48;5;237m  [48;5;236m  [48;5;235m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [0m
[48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;236m  [48;5;237m  [48;5;60m  [48;5;60m  [48;5;237m  [48;5;237m  [48;5;236m  [48;5;235m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [0m
[48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;236m  [48;5;237m  [48;5;236m  [48;5;235m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [48;5;0m  [0m
`;

  str.split('\n').forEach(l => ctx.writeln(l));
  ctx.writeln('OS.js Shell 0.1 - Type \'help\' for a list of commands');

  return Promise.resolve();
};
